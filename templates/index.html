<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PRIZM Code Lookup</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      .container {
        background-color: #f9f9f9;
        border-radius: 5px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"],
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #45a049;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        display: none;
      }
      .api-info {
        margin-top: 30px;
        border-top: 1px solid #ddd;
        padding-top: 20px;
      }
      code {
        background-color: #f5f5f5;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: monospace;
      }
      .loading {
        display: none;
        text-align: center;
        margin-top: 20px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .expandable-row {
        background-color: #f9f9f9;
        display: none;
      }
      .expand-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 2px 6px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }
      .expand-btn:hover {
        background: #0056b3;
      }
      .segment-description {
        max-width: 400px;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <h1>PRIZM Code Lookup</h1>

    <div class="container">
      <h2>Single Postal Code Lookup</h2>
      <div class="form-group">
        <label for="postal-code">Enter Canadian Postal Code:</label>
        <input
          type="text"
          id="postal-code"
          placeholder="e.g., V8A 2P4"
          required
        />
      </div>
      <button onclick="lookupSingle()">Lookup PRIZM Code</button>

      <div class="loading" id="single-loading">
        <div class="spinner"></div>
        <p>Looking up PRIZM code...</p>
      </div>

      <div class="result" id="single-result"></div>
    </div>

    <div class="container">
      <h2>Batch Postal Code Lookup</h2>
      <div class="form-group">
        <label for="batch-postal-codes"
          >Enter Multiple Canadian Postal Codes (one per line):</label
        >
        <textarea
          id="batch-postal-codes"
          rows="5"
          placeholder="e.g., V8A 2P4&#10;M5V 2H1&#10;K1A 0A9"
          required
        ></textarea>
      </div>
      <button onclick="lookupBatch()">Lookup PRIZM Codes</button>

      <div class="loading" id="batch-loading">
        <div class="spinner"></div>
        <p>Processing postal codes...</p>
      </div>

      <div class="result" id="batch-result"></div>
    </div>

    <div class="api-info">
      <h2>API Documentation</h2>
      <h3>Single Postal Code Lookup</h3>
      <p>Endpoint: <code>GET /api/prizm?postal_code=V8A2P4</code></p>
      <p>Response:</p>
      <pre><code>{
  "postal_code": "V8A 2P4",
  "prizm_code": "62",
  "segment_name": "Boomer Bliss",
  "segment_description": "Older, financially comfortable, suburban couples and families",
  "average_household_income": "$163,097",
  "education": "University/College",
  "urbanity": "Suburban",
  "average_household_net_worth": "$1,513,488",
  "occupation": "White Collar/Service Sector",
  "diversity": "Low",
  "family_life": "Couples/Families",
  "tenure": "Own",
  "home_type": "Single Detached",
  "status": "success"
}</code></pre>

      <h3>Batch Postal Code Lookup</h3>
      <p>Endpoint: <code>POST /api/prizm/batch</code></p>
      <p>Request Body:</p>
      <pre><code>{
  "postal_codes": ["V8A2P4", "M5V2H1", "K1A0A9"]
}</code></pre>
      <p>Response:</p>
      <pre><code>{
  "results": [
    {
      "postal_code": "V8A 2P4",
      "prizm_code": "62",
      "segment_name": "Boomer Bliss",
      "average_household_income": "$163,097",
      "average_household_net_worth": "$1,513,488",
      "education": "University/College",
      "urbanity": "Suburban",
      "occupation": "White Collar/Service Sector",
      "diversity": "Low",
      "family_life": "Couples/Families",
      "tenure": "Own",
      "home_type": "Single Detached",
      "status": "success"
    },
    {
      "postal_code": "M5V 2H1",
      "prizm_code": "01",
      "segment_name": "Urban Elite",
      "average_household_income": "$125,000",
      "average_household_net_worth": "$850,000",
      "education": "University/Graduate",
      "urbanity": "Urban Core",
      "occupation": "Executive/Professional",
      "diversity": "High",
      "family_life": "Singles/Couples",
      "tenure": "Own",
      "home_type": "High Rise Condo",
      "status": "success"
    },
    {
      "postal_code": "K1A 0A9",
      "prizm_code": "11",
      "segment_name": "Government Workers",
      "average_household_income": "$95,000",
      "average_household_net_worth": "$650,000",
      "education": "University/College",
      "urbanity": "Suburban",
      "occupation": "Government/Public Service",
      "diversity": "Medium",
      "family_life": "Families",
      "tenure": "Own",
      "home_type": "Single Detached",
      "status": "success"
    }
  ],
  "total": 3,
  "successful": 3
}</code></pre>
    </div>

    <script>
      function lookupSingle() {
        const postalCode = document.getElementById("postal-code").value.trim();
        if (!postalCode) {
          alert("Please enter a postal code");
          return;
        }

        const resultDiv = document.getElementById("single-result");
        const loadingDiv = document.getElementById("single-loading");

        resultDiv.style.display = "none";
        loadingDiv.style.display = "block";

        fetch(`/api/prizm?postal_code=${encodeURIComponent(postalCode)}`)
          .then((response) => response.json())
          .then((data) => {
            loadingDiv.style.display = "none";
            resultDiv.style.display = "block";

            if (data.status === "success") {
              let htmlContent = `
                            <h3>Result</h3>
                            <p><strong>Postal Code:</strong> ${data.postal_code}</p>
                            <p><strong>PRIZM Code:</strong> ${data.prizm_code}</p>
                        `;

              // Add segment name if available
              if (data.segment_name) {
                htmlContent += `<p><strong>Segment Name:</strong> ${data.segment_name}</p>`;
              }

              // Add segment description if available
              if (data.segment_description) {
                htmlContent += `<p><strong>Segment Description:</strong> ${data.segment_description}</p>`;
              }

              // Add comprehensive demographic data
              htmlContent += `<h4>Financial Profile</h4>`;
              if (data.average_household_income) {
                htmlContent += `<p><strong>Average Household Income:</strong> ${data.average_household_income}</p>`;
              }
              if (data.average_household_net_worth) {
                htmlContent += `<p><strong>Average Household Net Worth:</strong> ${data.average_household_net_worth}</p>`;
              }

              htmlContent += `<h4>Demographics & Lifestyle</h4>`;
              if (data.education) {
                htmlContent += `<p><strong>Education:</strong> ${data.education}</p>`;
              }
              if (data.urbanity) {
                htmlContent += `<p><strong>Urbanity:</strong> ${data.urbanity}</p>`;
              }
              if (data.occupation) {
                htmlContent += `<p><strong>Occupation:</strong> ${data.occupation}</p>`;
              }
              if (data.diversity) {
                htmlContent += `<p><strong>Diversity:</strong> ${data.diversity}</p>`;
              }
              if (data.family_life) {
                htmlContent += `<p><strong>Family Life:</strong> ${data.family_life}</p>`;
              }

              htmlContent += `<h4>Housing</h4>`;
              if (data.tenure) {
                htmlContent += `<p><strong>Tenure:</strong> ${data.tenure}</p>`;
              }
              if (data.home_type) {
                htmlContent += `<p><strong>Home Type:</strong> ${data.home_type}</p>`;
              }

              // Add note if it's mock data
              if (data.note) {
                htmlContent += `<p><em>Note: ${data.note}</em></p>`;
              }

              resultDiv.innerHTML = htmlContent;
            } else {
              resultDiv.innerHTML = `
                            <h3>Error</h3>
                            <p>${
                              data.message ||
                              "Could not find PRIZM code for this postal code"
                            }</p>
                        `;
            }
          })
          .catch((error) => {
            loadingDiv.style.display = "none";
            resultDiv.style.display = "block";
            resultDiv.innerHTML = `
                        <h3>Error</h3>
                        <p>An error occurred: ${error.message}</p>
                    `;
          });
      }

      function lookupBatch() {
        const postalCodesText = document
          .getElementById("batch-postal-codes")
          .value.trim();
        if (!postalCodesText) {
          alert("Please enter at least one postal code");
          return;
        }

        const postalCodes = postalCodesText
          .split("\n")
          .map((code) => code.trim())
          .filter((code) => code.length > 0);

        if (postalCodes.length === 0) {
          alert("Please enter at least one valid postal code");
          return;
        }

        const resultDiv = document.getElementById("batch-result");
        const loadingDiv = document.getElementById("batch-loading");

        resultDiv.style.display = "none";
        loadingDiv.style.display = "block";

        fetch("/api/prizm/batch", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ postal_codes: postalCodes }),
        })
          .then((response) => response.json())
          .then((data) => {
            loadingDiv.style.display = "none";
            resultDiv.style.display = "block";

            let html = `
                        <h3>Results (${data.successful} of ${data.total} successful)</h3>
                        <table style="width:100%; border-collapse: collapse;">
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Postal Code</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">PRIZM Code</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Segment Name</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Income</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Education</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Status</th>
                            </tr>
                    `;

            data.results.forEach((result, index) => {
              html += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${
                                  result.postal_code
                                }</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${
                                  result.prizm_code || "-"
                                }</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${
                                  result.segment_name || "-"
                                }</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${
                                  result.average_household_income || "-"
                                }</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${
                                  result.education || "-"
                                }</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">
                                    ${result.status}
                                    ${
                                      result.segment_description ||
                                      result.average_household_net_worth ||
                                      result.occupation ||
                                      result.urbanity ||
                                      result.diversity ||
                                      result.family_life ||
                                      result.tenure ||
                                      result.home_type
                                        ? `<br><button class="expand-btn" onclick="toggleDescription(${index})">View Details</button>`
                                        : ""
                                    }
                                </td>
                            </tr>
                        `;

              if (
                result.segment_description ||
                result.average_household_net_worth ||
                result.occupation ||
                result.urbanity ||
                result.diversity ||
                result.family_life ||
                result.tenure ||
                result.home_type
              ) {
                html += `
                                <tr id="desc-${index}" class="expandable-row">
                                    <td colspan="6" style="border: 1px solid #ddd; padding: 8px; background-color: #f9f9f9;">
                                        ${
                                          result.segment_name
                                            ? `<h4>${result.segment_name}</h4>`
                                            : ""
                                        }
                                        ${
                                          result.segment_description
                                            ? `<p><strong>Description:</strong> ${result.segment_description}</p>`
                                            : ""
                                        }
                                        
                                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 10px 0;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <h5>Financial Profile</h5>
                                                ${
                                                  result.average_household_income
                                                    ? `<p><strong>Household Income:</strong> ${result.average_household_income}</p>`
                                                    : ""
                                                }
                                                ${
                                                  result.average_household_net_worth
                                                    ? `<p><strong>Net Worth:</strong> ${result.average_household_net_worth}</p>`
                                                    : ""
                                                }
                                            </div>
                                            <div style="flex: 1; min-width: 200px;">
                                                <h5>Demographics</h5>
                                                ${
                                                  result.education
                                                    ? `<p><strong>Education:</strong> ${result.education}</p>`
                                                    : ""
                                                }
                                                ${
                                                  result.urbanity
                                                    ? `<p><strong>Urbanity:</strong> ${result.urbanity}</p>`
                                                    : ""
                                                }
                                                ${
                                                  result.occupation
                                                    ? `<p><strong>Occupation:</strong> ${result.occupation}</p>`
                                                    : ""
                                                }
                                                ${
                                                  result.diversity
                                                    ? `<p><strong>Diversity:</strong> ${result.diversity}</p>`
                                                    : ""
                                                }
                                            </div>
                                            <div style="flex: 1; min-width: 200px;">
                                                <h5>Lifestyle & Housing</h5>
                                                ${
                                                  result.family_life
                                                    ? `<p><strong>Family Life:</strong> ${result.family_life}</p>`
                                                    : ""
                                                }
                                                ${
                                                  result.tenure
                                                    ? `<p><strong>Tenure:</strong> ${result.tenure}</p>`
                                                    : ""
                                                }
                                                ${
                                                  result.home_type
                                                    ? `<p><strong>Home Type:</strong> ${result.home_type}</p>`
                                                    : ""
                                                }
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `;
              }
            });

            html += "</table>";
            resultDiv.innerHTML = html;
          })
          .catch((error) => {
            loadingDiv.style.display = "none";
            resultDiv.style.display = "block";
            resultDiv.innerHTML = `
                        <h3>Error</h3>
                        <p>An error occurred: ${error.message}</p>
                    `;
          });
      }

      function toggleDescription(index) {
        const row = document.getElementById(`desc-${index}`);
        const button = event.target;

        if (row.style.display === "none" || row.style.display === "") {
          row.style.display = "table-row";
          button.textContent = "Hide Details";
        } else {
          row.style.display = "none";
          button.textContent = "View Details";
        }
      }
    </script>
  </body>
</html>
